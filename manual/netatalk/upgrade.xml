<?xml version="1.0" encoding="UTF-8"?>
<chapter id="upgrade">
  <chapterinfo>
    <date>25.3.2012</date>

    <author>
      <firstname>Frank</firstname>

      <surname>Lahm</surname>
    </author>

    <pubdate>25 March, 2012</pubdate>
  </chapterinfo>

  <title>Upgrading from Netatalk 2</title>

  <sect1>
    <title>Overview</title>

    <para>There are two major changes in Netatalk:<orderedlist>
        <listitem>
          <para>New configuration file <option><link
          linkend="afp.conf.5">afp.conf</link></option>, obsoleting all
          previous configuration files</para>
        </listitem>

        <listitem>
          <para>New AppleDouble backend <option>apple double = ea</option>
          which stores Mac metadata and ressource forks in extended attributes
          of the filesystem</para>
        </listitem>
      </orderedlist></para>

    <sect2>
      <title>New configuration</title>

      <para><itemizedlist>
          <listitem>
            <para>ini style syntax (like Samba’s smb.conf)</para>
          </listitem>

          <listitem>
            <para>one to rule them all: configure AFP settings and volumes in
            one file</para>
          </listitem>

          <listitem>
            <para>obsoletes afpd.conf, netatalk.conf, AppleVolumes.default and
            afp_ldap.conf</para>
          </listitem>
        </itemizedlist><warning>
          <para>most option names have changed, read the full manpage <link
          linkend="afp.conf.5">afp.conf</link> for details</para>
        </warning></para>
    </sect2>

    <sect2>
      <title>New AppleDouble backend</title>

      <para>New AppleDouble backend <option>apple double = ea</option> which
      stores Mac metadata and ressource forks in extended attributes of the
      filesystem.<itemizedlist>
          <listitem>
            <para>default backend (!)</para>
          </listitem>

          <listitem>
            <para>requires a filesystem with Extended Attributes, fallback is
            <option>apple double = v2</option></para>
          </listitem>

          <listitem>
            <para>converts filesystems from <option>apple double = v2</option>
            to <option>apple double = ea</option> on the fly when accessed
            (can be disabled)</para>
          </listitem>

          <listitem>
            <para><command><link linkend="dbd.1">dbd</link></command> can be
            used to do conversion in one shot</para>
          </listitem>
        </itemizedlist></para>

      <para>Implementation details:<itemizedlist>
          <listitem>
            <para>stores Mac Metadata (eg FinderInfo, AFP Flags, Comment,
            CNID) in an Extended Attributed named
            “org.netatalk.Metadata”</para>
          </listitem>

          <listitem>
            <para>stores Mac RessourceFork either in<itemizedlist>
                <listitem>
                  <para>an Extended Attribute named
                  “org.netatalk.RessourceFork” on Solaris (FreeBSD?) w. ZFS,
                  or in</para>
                </listitem>

                <listitem>
                  <para>an extra AppleDouble file named “._file” for a file
                  named “file”</para>
                </listitem>
              </itemizedlist></para>
          </listitem>

          <listitem>
            <para>the format of the ._ file is exactly as the Mac’s CIFS
            client expects it when accessing the same filesystem via a CIFS
            server (Samba), thus you can have parallel access from Macs to the
            same dataset via AFP and CIFS without the risk of loosing data
            (ressources or metadata). Accessing the same dataset with CIFS
            from Windows clients will still break the coupling of “file” and
            “._file” on non ZFS filesystems (see above), so for this we still
            need an enhanced Samba VFS module (in the works).</para>
          </listitem>
        </itemizedlist></para>

      <para>As these days the only applications making use of Ressource Forks
      are Adobe Photoshop (image preview) and Postscript Type 1 fonts, even on
      eg Linux you’ll get rid of 99% of any extra Netatalk AppleDouble files
      (and folders).</para>
    </sect2>

    <sect2>
      <title>Other major changes</title>

      <para><itemizedlist>
          <listitem>
            <para>New service controller daemon <link
            linkend="netatalk.8">netatalk</link> which is responsible for
            starting and restarting the AFP and CNID daemons. All bundled
            start scripts have been updated, make sure to update yours!</para>
          </listitem>

          <listitem>
            <para>Netatalk 2.x volume options “usedots” and “upriv” now
            enabled by default</para>
          </listitem>

          <listitem>
            <para>Removed SLP and AFP proxy support</para>
          </listitem>

          <listitem>
            <para>Removed type/creator &lt;-&gt; extension mapping
            support</para>
          </listitem>
        </itemizedlist></para>
    </sect2>
  </sect1>

  <sect1>
    <title>Upgrading</title>

    <para><orderedlist>
        <listitem>
          <para>Stop Netatalk 2.x</para>
        </listitem>

        <listitem>
          <para>Install Netatalk 3</para>
        </listitem>

        <listitem>
          <para>Manually re-create configuration in
          <option>afp.conf</option></para>
        </listitem>

        <listitem>
          <para>Update your Netatalk start script (SMF, systemd, whatever...)
          to only start <link linkend="netatalk.8">netatalk</link>, not
          <command>afpd</command> not <command>cnid_metad</command></para>
        </listitem>

        <listitem>
          <para>The volume option <option>dbpath</option> has been made a
          global option called <option>vol dbpath</option>. It doesn’t support
          or require the use of variables, so make sure you remove
          them!</para>
        </listitem>

        <listitem>
          <para>Move <filename>afp_voluuid.conf</filename> and
          <filename>afp_signature.conf</filename> to state directory (default
          <filename>/var/netatalk/</filename>), use <command>afpd -v</command>
          in order to find the correct path</para>
        </listitem>

        <listitem>
          <para>Start Netatalk 3</para>
        </listitem>
      </orderedlist></para>
  </sect1>

  <sect1>
    <title>Notes</title>

    <itemizedlist>
      <listitem>
        <para>Solaris ZFS permissions</para>

        <para>On Solaris w. ZFS you have to make sure connecting users have
        filesystem access rights to read, create, modify (default: yes) and
        delete (default: no) extended attributes.</para>

        <para>To grant this right to a group called “staff” you’d use this
        command:</para>

        <para><command>pfexec chmod A+group:staff:RW:fd:allow
        /Volumes/test/</command></para>

        <para>Remember to run this once before you share a volume such that
        this permission inherits appropiately (fd flags in above
        command).</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1>
    <title>To Do</title>

    <para><itemizedlist>
        <listitem>
          <para>test <command>ad</command> utils with <option>apple double =
          ea</option></para>
        </listitem>
      </itemizedlist></para>
  </sect1>
</chapter>
